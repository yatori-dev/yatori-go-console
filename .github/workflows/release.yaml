name: Go Build and Release

on:
  push:
    tags:
      - 'v*' # è§¦å‘æ¡ä»¶ï¼šæ¨é€ tag
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v2.5.8-Beta.3'

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [ğŸ‘] æ–°ç‰ˆæœ¬æ”¯æŒæ–°å¹³å°éšè¡Œè¯¾å ‚
    - [ğŸ‘] éšè¡Œè¯¾å ‚æ”¯æŒç§’åˆ·å®Œæˆåº¦
    - [ğŸ‘] éšè¡Œè¯¾å ‚æ”¯æŒå­¦æ—¶æäº¤ç´¯è®¡
    - [â€ğŸ”§] å­¦ä¹ é€šä¿®å¤æ‹‰å–ç« èŠ‚ä¿¡æ¯è§¦å‘äººè„¸é—®é¢˜
    - [â€ğŸ”§] å­¦ä¹ é€šä¿®å¤å¤–ç½®é¢˜åº“åŠŸèƒ½éƒ¨åˆ†BUG
    
    æ³¨ï¼šæ­¤ç‰ˆæœ¬ç­”é¢˜åŠŸèƒ½æ­£åœ¨é‡æ„ä¸­ï¼Œæ‰€ä»¥å¯èƒ½æ— æ³•æ­£å¸¸ç­”é¢˜ï¼Œè‹¥æƒ³è¦æ­£å¸¸ç­”é¢˜è¯·å…ˆä½¿ç”¨è€ç‰ˆæœ¬ï¼Œä»¥åŠå¦‚æœæœ‰ç”¨æˆ·æä¾›è´¦å·æµ‹è¯•å¼€å‘æ–°ç‰ˆæœ¬ç­”é¢˜å°†æ„Ÿæ¿€ä¸å°½ã€‚

jobs:
  build:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            goos: linux
          - os: ubuntu-latest
            arch: arm64
            goos: linux
          - os: windows-latest
            arch: amd64
            goos: windows
          # å¦‚æœéœ€è¦ armv7 (32ä½) äº¤å‰ç¼–è¯‘ï¼ŒåŠ ä¸‹é¢ä¸€è¡Œ
          # - os: ubuntu-latest
          #   arch: arm
          #   goos: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev pkg-config gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Get dependencies
        if: runner.os=='Linux'
        run: |
          export GOPROXY=direct
          export GONOSUMDB=*
          rm -rf go.sum
          go clean -modcache
          go env -w GOSUMDB=off
          go mod tidy
      - name: Get dependencies
        if: runner.os=='Windows'
        run: |
          set GOPROXY=direct
          set GONOSUMDB=*
          go clean -modcache
          del go.sum
          go get -u ./...
          go mod tidy

      - name: Prepare Release Directory
        run: mkdir -p ${{ env.RELEASE_DIR }}/yatori-go-console.${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release

      - name: Build
        run: |
          CGO_ENABLED=1 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.arch }} go build -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}${{ matrix.goos == 'windows' && '.exe' || '' }}

      - name: Package
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            copy command\\config.yaml ${{ env.RELEASE_DIR }}\\yatori-go-console.${{ env.VERSION }}-windows-${{ matrix.arch }}-release
            copy command\\start.bat ${{ env.RELEASE_DIR }}\\yatori-go-console.${{ env.VERSION }}-windows-${{ matrix.arch }}-release
            cd ${{ env.RELEASE_DIR }}
            Compress-Archive -Path "yatori-go-console.${{ env.VERSION }}-windows-${{ matrix.arch }}-release" -DestinationPath "yatori-go-console.${{ env.VERSION }}-windows-${{ matrix.arch }}-release.zip"
            Remove-Item -Recurse -Force "yatori-go-console.${{ env.VERSION }}-windows-${{ matrix.arch }}-release"
            cd ..
          else
            cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
            cd ${{ env.RELEASE_DIR }}
            tar -czvf yatori-go-console.${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release.tar.gz yatori-go-console.${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
            rm -rf yatori-go-console.${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
            cd ..
          fi

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          draft: false
          prerelease: false
