name: Go Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v2.6.1-Beta.4'

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [üîß] ‰øÆÂ§çCQIEÁôªÂΩïÈÉ®ÂàÜÂ≠óÊÆµ‰∏∫Á©∫ÂØºËá¥Êó†Ê≥ïÊ≠£Â∏∏ÁôªÂΩïÈóÆÈ¢ò
    - [üîß] ‰øÆÂ§çCQIEÊó†Ê≥ïÊ≠£Â∏∏ÊãâÂèñËØæÁ®ãÈóÆÈ¢ò


jobs:
  build:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            goos: linux
          - os: ubuntu-latest
            arch: arm64
            goos: linux
          - os: windows-latest
            arch: amd64
            goos: windows
          - os: macos-latest
            arch: amd64
            goos: darwin
          - os: macos-latest
            arch: arm64
            goos: darwin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========== Linux glibc 2.17 build (amd64) ==========
      - name: Build on glibc 2.17 (CentOS7 - amd64)
        if: runner.os == 'Linux' && matrix.arch == 'amd64'
        run: |
          docker run --rm \
            -v $PWD:/src \
            -w /src \
            centos:7 \
            bash -c "
              yum install -y gcc gcc-c++ git make wget && \
              wget https://go.dev/dl/go1.21.5.linux-amd64.tar.gz && \
              tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz && \
              export PATH=/usr/local/go/bin:\$PATH && \
              go version && \
              CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -o ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-amd64-release/${PROJECT_NAME}
            "

      # ========== Linux glibc 2.17 build (arm64) ==========
      - name: Build on glibc 2.17 (CentOS7 - arm64)
        if: runner.os == 'Linux' && matrix.arch == 'arm64'
        run: |
          docker run --rm \
            --platform linux/arm64 \
            -v $PWD:/src \
            -w /src \
            centos:7 \
            bash -c "
              yum install -y gcc gcc-c++ git make wget && \
              wget https://go.dev/dl/go1.21.5.linux-arm64.tar.gz && \
              tar -C /usr/local -xzf go1.21.5.linux-arm64.tar.gz && \
              export PATH=/usr/local/go/bin:\$PATH && \
              go version && \
              CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -o ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-arm64-release/${PROJECT_NAME}
            "

      # ========== Windows ÊûÑÂª∫ ==========
      - name: Build Windows
        if: runner.os == 'Windows'
        run: |
          set CGO_ENABLED=1
          set GOOS=windows
          set GOARCH=${{ matrix.arch }}
          go build -o ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release\${{ env.PROJECT_NAME }}.exe

      # ========== macOS ÊûÑÂª∫ ==========
      - name: Build macOS
        if: matrix.goos == 'darwin'
        run: |
          CGO_ENABLED=1 GOOS=darwin GOARCH=${{ matrix.arch }} go build \
            -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      # -------- ÊâìÂåÖ Linux --------
      - name: Create release tar
        if: runner.os=='Linux'
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          cd ${{ env.RELEASE_DIR }}
          tar -czvf yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release.tar.gz yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          rm -rf yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          cd ..

      # -------- Windows ÂéãÁº© --------
      - name: Create Release zip
        if: runner.os=='Windows'
        run: |
          copy command\config.yaml ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release
          cd ${{ env.RELEASE_DIR }}
          Compress-Archive -Path "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release" -DestinationPath "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release.zip"
          Remove-Item -Recurse -Force "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release"
          cd ..

      # -------- macOS ÊâìÂåÖ --------
      - name: Create macOS Release tar
        if: matrix.goos == 'darwin'
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release
          cd ${{ env.RELEASE_DIR }}
          tar -czvf yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release.tar.gz yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release
          rm -rf yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release
          cd ..

      # ===== ÂèëÂ∏É Release =====
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          draft: false
