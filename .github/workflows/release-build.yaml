name: Go Build and Release

on:
  push:
    tags:
      - 'v*' # Ëß¶ÂèëÊù°‰ª∂ÔºöÊé®ÈÄÅ tag
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v2.6.1-Beta.4'

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [üîß] ‰øÆÂ§çCQIEÁôªÂΩïÈÉ®ÂàÜÂ≠óÊÆµ‰∏∫Á©∫ÂØºËá¥Êó†Ê≥ïÊ≠£Â∏∏ÁôªÂΩïÈóÆÈ¢ò
    - [üîß] ‰øÆÂ§çCQIEÊó†Ê≥ïÊ≠£Â∏∏ÊãâÂèñËØæÁ®ãÈóÆÈ¢ò
    
    Â≠¶‰π†ÈÄöÁî®Êà∑Ê≥®ÊÑèÔºö
        Â¶ÇÊûúÂ≠¶‰π†ÈÄöËØæÁ®ã‰∏≠ÊúâÂâçÁΩÆ‰ªªÂä°ÁÇπÂÆåÊàêÊâçËÉΩËß£ÈîÅÂêéÁª≠‰ªªÂä°ÁöÑ‰∏çËÉΩ‰ΩøÁî®Â§ö‰ªªÂä°ÁÇπÊ®°ÂºèÔºÅÔºÅÔºÅÔºàÂ§ö‰ªªÂä°ÁÇπÊ®°Âºè‰ºöÂ§±ÊïàÔºâ
        ÊØèÂ§©Â≠¶‰π†Á¥ØËÆ°Â≠¶Êó∂‰∏çË¶ÅÂ§™‰πÖÔºåË∂ÖËøá1200ÂàÜÈíüÂèØËÉΩ‰ºöÊâìÂõûÂ≠¶‰π†ËøõÂ∫¶ÔºàÂ∞§ÂÖ∂ÊòØÂ§öËØæÁ®ãÊàñÂ§ö‰ªªÂä°ÁÇπÊ®°ÂºèÔºâÔºåËØ∑Ëá™Ë°åÊääÊéßÂ•Ω„ÄÇÂõ†‰∏∫Â§™Á¶ªË∞±‰∫Ü„ÄÇ
    
    Ê≥®ÔºöÊô∫ÊÖßËÅåÊïôÂàö‰∏äÁ∫øÔºåÂèØËÉΩÂπ∂‰∏çÁ®≥ÂÆöÔºåËã•ÊúâbugÂèØÂèëÈÄÅissueÊàñËÄÖÂä†Áæ§ÂèçÈ¶à„ÄÇÔºàÊô∫ÊÖßËÅåÊïô‰ªÖÊîØÊåÅWindowsÁ≥ªÁªüÔºâ

jobs:
  build:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # ‰ΩøÁî® CentOS 7 ÊûÑÂª∫ Linux ÁâàÊú¨
          - os: ubuntu-latest
            container:
              image: centos:7
            arch: amd64
            goos: linux
            platform: centos7
          - os: ubuntu-latest
            container:
              image: centos:7
            arch: arm64
            goos: linux
            platform: centos7
          - os: windows-latest
            arch: amd64
            goos: windows
          - os: macos-latest
            arch: amd64
            goos: darwin
          - os: macos-latest
            arch: arm64
            goos: darwin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ËÆæÁΩÆ CentOS 7 ÁéØÂ¢ÉÔºà‰ªÖ Linux ÊûÑÂª∫Ôºâ
      - name: Setup CentOS 7 environment for Linux builds
        if: matrix.platform == 'centos7'
        run: |
          # Êõ¥Êñ∞ yum ‰ªìÂ∫ìÂπ∂ÂÆâË£ÖÂü∫Á°Ä‰æùËµñ
          yum update -y
          yum install -y epel-release
          yum install -y wget tar gzip gcc gcc-c++ make glibc-devel glibc-static
          
          # ÂÆâË£Ö‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑Èìæ
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            # ÂÆâË£Ö aarch64 ‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑
            yum install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          elif [ "${{ matrix.arch }}" = "arm" ]; then
            # ÂÆâË£Ö armv7 ‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑
            yum install -y gcc-arm-linux-gnu binutils-arm-linux-gnu
          fi

      # ‰∏∫ÂÖ∂‰ªñÂπ≥Âè∞ËÆæÁΩÆÁéØÂ¢É
      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux' && matrix.platform != 'centos7'
        run: |
          apt-get update
          apt-get install -y libasound2-dev pkg-config

      # Set up Go - ÈúÄË¶ÅÂú®ÂÆπÂô®ÂÜÖÂÆâË£Ö
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'  # Use Go version from go.mod
          cache: true  # Enable dependency caching

      - name: Install Go on CentOS 7 (if needed)
        if: matrix.platform == 'centos7'
        run: |
          # Â¶ÇÊûú setup-go Âú®ÂÆπÂô®‰∏≠Êó†Ê≥ïÊ≠£Â∏∏Â∑•‰ΩúÔºåÊâãÂä®ÂÆâË£Ö Go
          if ! command -v go &> /dev/null; then
            echo "Installing Go manually on CentOS 7"
            wget https://golang.org/dl/go1.21.0.linux-amd64.tar.gz
            tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
            echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
            source ~/.bashrc
          fi

      - name: Get dependencies
        run: |
          # ËÆæÁΩÆ Go ÁéØÂ¢ÉÂèòÈáè
          if [ "${{ runner.os }}" = "Linux" ]; then
            export GOPROXY=direct
            export GONOSUMDB=*
            go env -w GOSUMDB=off
          elif [ "${{ runner.os }}" = "macOS" ]; then
            export GOPROXY=direct
            export GONOSUMDB=*
            go env -w GOSUMDB=off
          elif [ "${{ runner.os }}" = "Windows" ]; then
            set GOPROXY=direct
            set GONOSUMDB=*
            go env -w GOSUMDB=off
          fi
          
          # Ê∏ÖÁêÜÂíåËé∑Âèñ‰æùËµñ
          rm -f go.sum
          go clean -modcache
          go mod tidy

      - name: Prepare Release Directory
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release

      # Âú® CentOS 7 ÂÆπÂô®‰∏≠ÊûÑÂª∫ Linux
      - name: Build Linux on CentOS 7
        if: matrix.platform == 'centos7' && matrix.arch == 'amd64'
        run: |
          # Âú® CentOS 7 ÁéØÂ¢É‰∏≠ÊûÑÂª∫
          CGO_ENABLED=1 GOOS=linux GOARCH=${{ matrix.arch }} \
          go build -o ${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      - name: Build Linux ARM64 on CentOS 7
        if: matrix.platform == 'centos7' && matrix.arch == 'arm64'
        run: |
          # ‰ΩøÁî®‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑ÈìæÊûÑÂª∫ arm64
          CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 \
          GOOS=linux GOARCH=${{ matrix.arch }} \
          go build -o ${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      # Build Windows
      - name: Build Windows
        if: runner.os == 'Windows'
        run: |
          set CGO_ENABLED=1
          set GOOS=windows 
          set GOARCH=${{ matrix.arch }} 
          go build -o ${{ env.RELEASE_DIR }}\${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release\${{ env.PROJECT_NAME }}.exe

      # Build macOS
      - name: Build macOS
        if: matrix.goos == 'darwin'
        run: |
          CGO_ENABLED=1 GOOS=darwin GOARCH=${{ matrix.arch }} \
          go build -o ${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      # Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
      - name: Copy configuration files
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            if [ "${{ runner.os }}" = "Windows" ]; then
              copy command\config.yaml ${{ env.RELEASE_DIR }}\${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
              copy command\start.bat ${{ env.RELEASE_DIR }}\${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
              copy command\ÂèåÂáªstart.batÂêØÂä®Á®ãÂ∫è ${{ env.RELEASE_DIR }}\${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
            fi
          else
            if [ "${{ runner.os }}" = "Linux" ] || [ "${{ runner.os }}" = "macOS" ]; then
              cp command/config.yaml ${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release/
            fi
          fi

      # ÊâìÂåÖ‰∏çÂêåÂπ≥Âè∞ÁöÑÂèëÂ∏ÉÊñá‰ª∂
      - name: Package Linux release (tar.gz)
        if: matrix.goos == 'linux'
        run: |
          cd ${{ env.RELEASE_DIR }}
          tar -czvf ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release.tar.gz ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
          rm -rf ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
          cd ..

      - name: Package Windows release (zip)
        if: runner.os == 'Windows' && matrix.goos == 'windows'
        run: |
          cd ${{ env.RELEASE_DIR }}
          Compress-Archive -Path "${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release" -DestinationPath "${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release.zip"
          Remove-Item -Recurse -Force "${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release"
          cd ..

      - name: Package macOS release (tar.gz)
        if: matrix.goos == 'darwin'
        run: |
          cd ${{ env.RELEASE_DIR }}
          tar -czvf ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release.tar.gz ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
          rm -rf ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
          cd ..

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*  # Êñá‰ª∂ÂèëÂ∏ÉÁõÆÂΩï
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          draft: false
          prerelease: false