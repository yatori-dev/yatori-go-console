name: Go Build and Release (Docker glibc 2.31)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name for the release"
        required: true
        default: "v1.0.0"

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [üîß] ‰øÆÂ§çCQIEÁôªÂΩïÂ≠óÊÆµÈóÆÈ¢ò
    - [üîß] ‰øÆÂ§çCQIEÊó†Ê≥ïÊãâÂèñËØæÁ®ãÈóÆÈ¢ò

jobs:

  linux-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Linux inside Docker (glibc 2.31)
        run: |
          docker run --rm \
            -v $PWD:/app \
            -w /app \
            ubuntu:20.04 \
            bash -c "
              export DEBIAN_FRONTEND=noninteractive &&
              apt-get update &&
              apt-get install -y tzdata --no-install-recommends &&
              apt-get install -y golang gcc-aarch64-linux-gnu gcc pkg-config tar &&

              export CGO_ENABLED=1 &&
              export GOOS=linux &&
              export GOARCH=${{ matrix.arch }} &&
              if [ '${{ matrix.arch }}' = 'arm64' ]; then export CC=aarch64-linux-gnu-gcc; fi &&

              rm -rf go.sum &&
              go mod tidy &&

              mkdir -p ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release &&
              go build -o ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release/${PROJECT_NAME} &&
              cp command/config.yaml ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release &&

              cd ${RELEASE_DIR} &&
              tar -czvf yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release.tar.gz yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release &&
              rm -rf yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release
            "

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: ${{ env.RELEASE_DIR }}/*.tar.gz


  # ---------------- Windows Build ----------------
  windows-build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Build Windows
        run: |
          mkdir $env:RELEASE_DIR\yatori-go-console.${env:VERSION}-windows-amd64-release
          go build -o $env:RELEASE_DIR\yatori-go-console.${env:VERSION}-windows-amd64-release\$env:PROJECT_NAME.exe

          copy command\config.yaml $env:RELEASE_DIR\yatori-go-console.${env:VERSION}-windows-amd64-release
          copy command\start.bat $env:RELEASE_DIR\yatori-go-console.${env:VERSION}-windows-amd64-release

          cd $env:RELEASE_DIR
          Compress-Archive -Path "yatori-go-console.${env:VERSION}-windows-amd64-release" `
                           -DestinationPath "yatori-go-console.${env:VERSION}-windows-amd64-release.zip"
          rm -Recurse -Force "yatori-go-console.${env:VERSION}-windows-amd64-release"

      - name: Upload Win artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: ${{ env.RELEASE_DIR }}/*.zip



  # ---------------- macOS Build ----------------
  mac-build:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Build macOS
        run: |
          export GOOS=darwin
          export GOARCH=${{ matrix.arch }}
          export CGO_ENABLED=1

          mkdir -p $RELEASE_DIR/yatori-go-console.$VERSION-darwin-${{ matrix.arch }}-release
          go build -o $RELEASE_DIR/yatori-go-console.$VERSION-darwin-${{ matrix.arch }}-release/$PROJECT_NAME
          cp command/config.yaml $RELEASE_DIR/yatori-go-console.$VERSION-darwin-${{ matrix.arch }}-release

          cd $RELEASE_DIR
          tar -czvf yatori-go-console.$VERSION-darwin-${{ matrix.arch }}-release.tar.gz yatori-go-console.$VERSION-darwin-${{ matrix.arch }}-release
          rm -rf yatori-go-console.$VERSION-darwin-${{ matrix.arch }}-release

      - name: Upload mac artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.arch }}
          path: ${{ env.RELEASE_DIR }}/*.tar.gz


  # ---------------- Final Release ----------------
  release:
    needs: [linux-build, mac-build, windows-build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          files: artifacts/**/*
          draft: false
          prerelease: false
