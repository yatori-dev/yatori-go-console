name: Go Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v2.6.1-Beta.4'

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [ğŸ”§] ä¿®å¤CQIEç™»å½•éƒ¨åˆ†å­—æ®µä¸ºç©ºå¯¼è‡´æ— æ³•æ­£å¸¸ç™»å½•é—®é¢˜
    - [ğŸ”§] ä¿®å¤CQIEæ— æ³•æ­£å¸¸æ‹‰å–è¯¾ç¨‹é—®é¢˜

    å­¦ä¹ é€šç”¨æˆ·æ³¨æ„ï¼š
        å¦‚æœå­¦ä¹ é€šè¯¾ç¨‹ä¸­æœ‰å‰ç½®ä»»åŠ¡ç‚¹å®Œæˆæ‰èƒ½è§£é”åç»­ä»»åŠ¡çš„ä¸èƒ½ä½¿ç”¨å¤šä»»åŠ¡ç‚¹æ¨¡å¼ï¼ï¼ï¼
        æ¯å¤©å­¦ä¹ ç´¯è®¡å­¦æ—¶ä¸è¦å¤ªä¹…ï¼Œè¶…è¿‡1200åˆ†é’Ÿå¯èƒ½ä¼šæ‰“å›å­¦ä¹ è¿›åº¦ï¼Œè¯·è‡ªè¡ŒæŠŠæ§å¥½ã€‚

jobs:

  # ===========================================================
  #  Linux (amd64/arm64) â€” ä½¿ç”¨ CentOS7 (glibc 2.17) Docker æ„å»º
  # ===========================================================
  linux-build:
    name: Build Linux (CentOS7 glibc2.17) â€” ${{ matrix.arch }}
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build inside CentOS 7
        run: |
          docker run --rm \
            -v $PWD:/app \
            -w /app \
            centos:7 \
            bash -c "
              yum install -y epel-release &&
              yum install -y golang tar which make git gcc \
                             centos-release-scl \
                             devtoolset-7 devtoolset-7-gcc devtoolset-7-gcc-c++ &&

              # å¯åŠ¨æ–° gcc7
              source /opt/rh/devtoolset-7/enable &&

              # arm64 äº¤å‰ç¼–è¯‘å·¥å…·
              if [ '${{ matrix.arch }}' = 'arm64' ]; then
                yum install -y aarch64-linux-gnu-gcc || true
                export CC=aarch64-linux-gnu-gcc
              fi

              export GOPROXY=https://goproxy.cn,direct
              export GOSUMDB=off

              rm -f go.sum
              go mod tidy

              mkdir -p ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release

              CGO_ENABLED=1 GOOS=linux GOARCH=${{ matrix.arch }} go build \
                -o ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release/${PROJECT_NAME}

              cp command/config.yaml ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release

              cd ${RELEASE_DIR}
              tar -czvf yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release.tar.gz yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release
              rm -rf yatori-go-console.${VERSION}-linux-${{ matrix.arch }}-release
            "

      - uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: ${{ env.RELEASE_DIR }}/*.tar.gz


  # ===========================================================
  #   Windows æ„å»º
  # ===========================================================
  windows-build:
    name: Build Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Get dependencies
        run: |
          set GOPROXY=direct
          set GOSUMDB=off
          go mod tidy

      - name: Build Windows
        run: |
          mkdir %RELEASE_DIR%\yatori-go-console.%VERSION%-windows-amd64-release
          go build -o %RELEASE_DIR%\yatori-go-console.%VERSION%-windows-amd64-release\%PROJECT_NAME%.exe

      - name: Create ZIP
        run: |
          copy command\config.yaml %RELEASE_DIR%\yatori-go-console.%VERSION%-windows-amd64-release
          copy command\start.bat %RELEASE_DIR%\yatori-go-console.%VERSION%-windows-amd64-release

          cd %RELEASE_DIR%
          Compress-Archive -Path "yatori-go-console.%VERSION%-windows-amd64-release" -DestinationPath "yatori-go-console.%VERSION%-windows-amd64-release.zip"
          cd ..

      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: release/*.zip


  # ===========================================================
  #  macOS æ„å»º (amd64 + arm64)
  # ===========================================================
  mac-build:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest

    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Get dependencies
        run: |
          export GOPROXY=direct
          export GOSUMDB=off
          go mod tidy

      - name: Build macOS
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release
          CGO_ENABLED=1 GOOS=darwin GOARCH=${{ matrix.arch }} go build \
            -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      - name: TAR
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release
          cd ${{ env.RELEASE_DIR }}
          tar -czvf yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release.tar.gz yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release
          cd ..

      - uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.arch }}
          path: release/*.tar.gz


  # ===========================================================
  #   Release å‘å¸ƒ
  # ===========================================================
  release:
    needs: [linux-build, windows-build, mac-build]
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: artifacts/**/*
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          draft: false
          prerelease: false
