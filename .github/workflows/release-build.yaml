name: Go Build and Release

on:
  push:
    tags:
      - 'v*' # è§¦å‘æ¡ä»¶ï¼šæ¨é€ tag
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v2.6.0-Beta.9'

permissions:
  contents: write
#  - [ğŸ‘]
#  - [â€ğŸ”§]
#  - [â˜ ï¸]
env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [ğŸ‘] æ¢å¤å¹¶ä¼˜åŒ–é‚®ç®±é€šçŸ¥åŠŸèƒ½
    
    
    å­¦ä¹ é€šç”¨æˆ·æ³¨æ„ï¼š
        å¦‚æœå­¦ä¹ é€šè¯¾ç¨‹ä¸­æœ‰å‰ç½®ä»»åŠ¡ç‚¹å®Œæˆæ‰èƒ½è§£é”åç»­ä»»åŠ¡çš„ä¸èƒ½ä½¿ç”¨å¤šä»»åŠ¡ç‚¹æ¨¡å¼ï¼ï¼ï¼ï¼ˆå¤šä»»åŠ¡ç‚¹æ¨¡å¼ä¼šå¤±æ•ˆï¼‰
        æ¯å¤©å­¦ä¹ ç´¯è®¡å­¦æ—¶ä¸è¦å¤ªä¹…ï¼Œè¶…è¿‡1200åˆ†é’Ÿå¯èƒ½ä¼šæ‰“å›å­¦ä¹ è¿›åº¦ï¼ˆå°¤å…¶æ˜¯å¤šè¯¾ç¨‹æˆ–å¤šä»»åŠ¡ç‚¹æ¨¡å¼ï¼‰ï¼Œè¯·è‡ªè¡ŒæŠŠæ§å¥½ã€‚å› ä¸ºå¤ªç¦»è°±äº†ã€‚
    
    æ³¨ï¼šæ™ºæ…§èŒæ•™åˆšä¸Šçº¿ï¼Œå¯èƒ½å¹¶ä¸ç¨³å®šï¼Œè‹¥æœ‰bugå¯å‘é€issueæˆ–è€…åŠ ç¾¤åé¦ˆã€‚ï¼ˆæ™ºæ…§èŒæ•™ä»…æ”¯æŒWindowsç³»ç»Ÿï¼‰
jobs:
  build:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            goos: linux
          - os: ubuntu-latest
            arch: arm64
            goos: linux
          - os: windows-latest
            arch: amd64
            goos: windows
          - os: macos-latest
            arch: amd64
            goos: darwin
          - os: macos-latest
            arch: arm64
            goos: darwin
          # å¦‚æœéœ€è¦ armv7 (32ä½) äº¤å‰ç¼–è¯‘ï¼ŒåŠ ä¸‹é¢ä¸€è¡Œ
          # - os: ubuntu-latest
          #   arch: arm
          #   goos: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux' && matrix.arch=='amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev pkg-config gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux' && matrix.arch=='arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
#  sudo dpkg --add-architecture arm64
#  sudo apt-get update
#  sudo apt-get install -y libc6:arm64 libc6-dev:arm64
#  sudo apt-get install -y libasound2-dev:arm64 pkg-config gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      # Set up Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'  # Use Go version from go.mod
          cache: true  # Enable dependency caching

      - name: Get dependencies(Linux)
        if: runner.os == 'Linux'
        run: |
          export GOPROXY=direct
          export GONOSUMDB=*
          rm -rf go.sum
          go clean -modcache
          go env -w GOSUMDB=off
          go mod tidy

      - name: Get dependencies(MacOS)
        if: runner.os == 'macOS'
        run: |
          export GOPROXY=direct
          export GONOSUMDB=*
          rm -rf go.sum
          go clean -modcache
          go env -w GOSUMDB=off
          go mod tidy

      - name: Get dependencies(Windows)
        if: runner.os=='Windows'
        run: |
          set GOPROXY=direct
          set GONOSUMDB=*
          go clean -modcache
          del go.sum
          go get -u ./...
          go mod tidy

      - name: Prepare Release Directory #åˆ›å»ºå‹ç¼©ç›®å½•
        run: mkdir -p ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release


      # Build Linux
      - name: Build Linux
        if: runner.os=='Linux' && matrix.arch=='amd64'
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=${{matrix.arch}} go build \
            -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release/${{ env.PROJECT_NAME }}

      # Build Linux
      - name: Build Linux
        if: runner.os=='Linux' && matrix.arch=='arm64'
        run: |
          CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=${{matrix.arch}} go build \
            -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release/${{ env.PROJECT_NAME }}

      # Build Windows
      - name: Build Windows
        if: runner.os == 'Windows'
        run: |
          set CGO_ENABLED=1
          set GOOS=windows 
          set GOARCH=${{matrix.arch}} 
          go build -o ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release\${{ env.PROJECT_NAME }}.exe

      # ğŸ§± æ„å»º Macos
      - name: Build macOS
        if: matrix.goos == 'darwin'
        run: |
          CGO_ENABLED=1 GOOS=darwin GOARCH=${{ matrix.arch }} go build \
            -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      - name: Create release tar
        if: runner.os=='Linux'
        run: | # æ‰“åŒ…å‘å¸ƒç‰ˆæœ¬å‹ç¼©åŒ…
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          cd ${{ env.RELEASE_DIR }}
          tar -czvf yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release.tar.gz yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          rm -rf yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          cd ..


      - name: Create Release zip
        if: runner.os=='Windows'
        run: |
          copy command\config.yaml ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release
          copy command\start.bat ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release
          copy command\åŒå‡»start.batå¯åŠ¨ç¨‹åº ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release
          cd ${{ env.RELEASE_DIR }}
          Compress-Archive -Path "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release" -DestinationPath "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release.zip"
          Remove-Item -Recurse -Force "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release"
          cd ..

      # ğŸ“¦ æ‰“åŒ… macOS (amd64+arm64)
      - name: Create macOS Release tar
        if: matrix.goos == 'darwin'
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release
          cd ${{ env.RELEASE_DIR }}
          tar -czvf yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release.tar.gz yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release
          rm -rf yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release
          cd ..

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*  # æ–‡ä»¶å‘å¸ƒç›®å½•
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          draft: false
          prerelease: false
