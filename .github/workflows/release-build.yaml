name: Go Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v2.6.1-Beta.4'

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [üîß] ‰øÆÂ§çCQIEÁôªÂΩïÈÉ®ÂàÜÂ≠óÊÆµ‰∏∫Á©∫ÂØºËá¥Êó†Ê≥ïÊ≠£Â∏∏ÁôªÂΩïÈóÆÈ¢ò
    - [üîß] ‰øÆÂ§çCQIEÊó†Ê≥ïÊ≠£Â∏∏ÊãâÂèñËØæÁ®ãÈóÆÈ¢ò
    
    Â≠¶‰π†ÈÄöÁî®Êà∑Ê≥®ÊÑèÔºö
        Â¶ÇÊûúÂ≠¶‰π†ÈÄöËØæÁ®ã‰∏≠ÊúâÂâçÁΩÆ‰ªªÂä°ÁÇπÂÆåÊàêÊâçËÉΩËß£ÈîÅÂêéÁª≠‰ªªÂä°ÁöÑ‰∏çËÉΩ‰ΩøÁî®Â§ö‰ªªÂä°ÁÇπÊ®°ÂºèÔºÅÔºÅÔºÅÔºàÂ§ö‰ªªÂä°ÁÇπÊ®°Âºè‰ºöÂ§±ÊïàÔºâ
        ÊØèÂ§©Â≠¶‰π†Á¥ØËÆ°Â≠¶Êó∂‰∏çË¶ÅÂ§™‰πÖÔºåË∂ÖËøá1200ÂàÜÈíüÂèØËÉΩ‰ºöÊâìÂõûÂ≠¶‰π†ËøõÂ∫¶ÔºàÂ∞§ÂÖ∂ÊòØÂ§öËØæÁ®ãÊàñÂ§ö‰ªªÂä°ÁÇπÊ®°ÂºèÔºâÔºåËØ∑Ëá™Ë°åÊääÊéßÂ•Ω„ÄÇÂõ†‰∏∫Â§™Á¶ªË∞±‰∫Ü„ÄÇ
    
    Ê≥®ÔºöÊô∫ÊÖßËÅåÊïôÂàö‰∏äÁ∫øÔºåÂèØËÉΩÂπ∂‰∏çÁ®≥ÂÆöÔºåËã•ÊúâbugÂèØÂèëÈÄÅissueÊàñËÄÖÂä†Áæ§ÂèçÈ¶à„ÄÇÔºàÊô∫ÊÖßËÅåÊïô‰ªÖÊîØÊåÅWindowsÁ≥ªÁªüÔºâ

jobs:
  # ‰∏ìÈó®Áî®‰∫é CentOS 7 ÊûÑÂª∫ÁöÑÂ∑•‰Ωú
  build-centos:
    name: Build CentOS 7 (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    container:
      image: centos:7
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install CentOS 7 dependencies
        run: |
          # ÂÆâË£ÖÂü∫Á°ÄÂ∑•ÂÖ∑
          yum update -y
          yum install -y wget tar gzip gcc gcc-c++ make glibc-devel glibc-static
          
          # ÂÆâË£Ö‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑Èìæ
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            # CentOS 7 ÂÆòÊñπ‰ªìÂ∫ìÂèØËÉΩÊ≤°Êúâ aarch64 ‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑
            # ‰ªé EPEL ‰ªìÂ∫ìÂÆâË£Ö
            yum install -y epel-release
            yum install -y gcc-aarch64-linux-gnu
          fi

      - name: Install Go
        run: |
          # ‰∏ãËΩΩÂπ∂ÂÆâË£Ö Go
          wget -q https://dl.google.com/go/go1.21.0.linux-amd64.tar.gz
          tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
          export PATH=$PATH:/usr/local/go/bin
          echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
          
          # È™åËØÅÂÆâË£Ö
          go version

      - name: Get Go dependencies
        run: |
          export PATH=$PATH:/usr/local/go/bin
          export GOPROXY=direct
          export GONOSUMDB=*
          go env -w GOSUMDB=off
          
          # Ê∏ÖÁêÜÂíåËé∑Âèñ‰æùËµñ
          rm -f go.sum
          go clean -modcache
          go mod tidy

      - name: Prepare Release Directory
        run: |
          mkdir -p /tmp/${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-linux-${{ matrix.arch }}-release

      - name: Build for amd64
        if: matrix.arch == 'amd64'
        run: |
          export PATH=$PATH:/usr/local/go/bin
          CGO_ENABLED=1 GOOS=linux GOARCH=${{ matrix.arch }} \
          go build -o /tmp/${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-linux-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      - name: Build for arm64
        if: matrix.arch == 'arm64'
        run: |
          export PATH=$PATH:/usr/local/go/bin
          if command -v aarch64-linux-gnu-gcc &> /dev/null; then
            CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=${{ matrix.arch }} \
            go build -o /tmp/${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-linux-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}
          else
            # Â¶ÇÊûúÊ≤°Êúâ‰∫§ÂèâÁºñËØëÂ∑•ÂÖ∑ÔºåÂ∞ùËØïÁõ¥Êé•ÁºñËØë
            echo "Warning: aarch64-linux-gnu-gcc not found, attempting direct build"
            CGO_ENABLED=0 GOOS=linux GOARCH=${{ matrix.arch }} \
            go build -o /tmp/${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-linux-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}
          fi

      - name: Copy configuration files
        run: |
          if [ -f "command/config.yaml" ]; then
            cp command/config.yaml /tmp/${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-linux-${{ matrix.arch }}-release/
          fi

      - name: Package release
        run: |
          cd /tmp/${{ env.RELEASE_DIR }}
          tar -czvf ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-linux-${{ matrix.arch }}-release.tar.gz ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-linux-${{ matrix.arch }}-release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: centos7-build-${{ matrix.arch }}
          path: /tmp/${{ env.RELEASE_DIR }}/*.tar.gz
          retention-days: 1

  # ÂÖ∂‰ªñÂπ≥Âè∞ÁöÑÊûÑÂª∫
  build-other:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    needs: build-centos
    strategy:
      matrix:
        include:
          - os: windows-latest
            arch: amd64
            goos: windows
          - os: macos-latest
            arch: amd64
            goos: darwin
          - os: macos-latest
            arch: arm64
            goos: darwin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Get dependencies
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            export GOPROXY=direct
            export GONOSUMDB=*
            go env -w GOSUMDB=off
          elif [ "${{ runner.os }}" = "macOS" ]; then
            export GOPROXY=direct
            export GONOSUMDB=*
            go env -w GOSUMDB=off
          elif [ "${{ runner.os }}" = "Windows" ]; then
            set GOPROXY=direct
            set GONOSUMDB=*
            go env -w GOSUMDB=off
          fi
          
          rm -f go.sum
          go clean -modcache
          go mod tidy

      - name: Prepare Release Directory
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release

      - name: Build Windows
        if: runner.os == 'Windows'
        run: |
          set CGO_ENABLED=1
          set GOOS=windows 
          set GOARCH=${{ matrix.arch }} 
          go build -o ${{ env.RELEASE_DIR }}\${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release\${{ env.PROJECT_NAME }}.exe

      - name: Build macOS
        if: matrix.goos == 'darwin'
        run: |
          CGO_ENABLED=1 GOOS=darwin GOARCH=${{ matrix.arch }} \
          go build -o ${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      - name: Copy configuration files for Windows
        if: runner.os == 'Windows'
        run: |
          copy command\config.yaml ${{ env.RELEASE_DIR }}\${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
          copy command\start.bat ${{ env.RELEASE_DIR }}\${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
          copy command\ÂèåÂáªstart.batÂêØÂä®Á®ãÂ∫è ${{ env.RELEASE_DIR }}\${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release

      - name: Copy configuration files for macOS
        if: matrix.goos == 'darwin'
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release/

      - name: Package Windows release
        if: runner.os == 'Windows'
        run: |
          cd ${{ env.RELEASE_DIR }}
          Compress-Archive -Path "${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release" -DestinationPath "${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release.zip"
          Remove-Item -Recurse -Force "${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release"
          cd ..

      - name: Package macOS release
        if: matrix.goos == 'darwin'
        run: |
          cd ${{ env.RELEASE_DIR }}
          tar -czvf ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release.tar.gz ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
          rm -rf ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.goos }}-${{ matrix.arch }}-release
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.goos }}-build-${{ matrix.arch }}
          path: ${{ env.RELEASE_DIR }}/*
          retention-days: 1

  # ÂèëÂ∏ÉÈò∂ÊÆµ
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-centos, build-other]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: find artifacts -type f

      - name: Prepare release files
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          # Â∞ÜÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©ÁßªÂä®Âà∞ release ÁõÆÂΩï
          find artifacts -name "*.tar.gz" -o -name "*.zip" | while read file; do
            cp "$file" ${{ env.RELEASE_DIR }}/
          done
          
          # ÂàóÂá∫ÊúÄÁªàË¶ÅÂèëÂ∏ÉÁöÑÊñá‰ª∂
          ls -la ${{ env.RELEASE_DIR }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          draft: false
          prerelease: false