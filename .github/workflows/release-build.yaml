name: Go Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v2.6.1-Beta.4'

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [ðŸ”§] ä¿®å¤CQIEç™»å½•éƒ¨åˆ†å­—æ®µä¸ºç©ºå¯¼è‡´æ— æ³•æ­£å¸¸ç™»å½•é—®é¢˜
    - [ðŸ”§] ä¿®å¤CQIEæ— æ³•æ­£å¸¸æ‹‰å–è¯¾ç¨‹é—®é¢˜
    
    å­¦ä¹ é€šç”¨æˆ·æ³¨æ„ï¼š
        å¦‚æžœå­¦ä¹ é€šè¯¾ç¨‹ä¸­æœ‰å‰ç½®ä»»åŠ¡ç‚¹å®Œæˆæ‰èƒ½è§£é”åŽç»­ä»»åŠ¡çš„ä¸èƒ½ä½¿ç”¨å¤šä»»åŠ¡ç‚¹æ¨¡å¼ï¼ï¼ï¼ï¼ˆå¤šä»»åŠ¡ç‚¹æ¨¡å¼ä¼šå¤±æ•ˆï¼‰
        æ¯å¤©å­¦ä¹ ç´¯è®¡å­¦æ—¶ä¸è¦å¤ªä¹…ï¼Œè¶…è¿‡1200åˆ†é’Ÿå¯èƒ½ä¼šæ‰“å›žå­¦ä¹ è¿›åº¦ï¼ˆå°¤å…¶æ˜¯å¤šè¯¾ç¨‹æˆ–å¤šä»»åŠ¡ç‚¹æ¨¡å¼ï¼‰ï¼Œè¯·è‡ªè¡ŒæŠŠæŽ§å¥½ã€‚å› ä¸ºå¤ªç¦»è°±äº†ã€‚
    
    æ³¨ï¼šæ™ºæ…§èŒæ•™åˆšä¸Šçº¿ï¼Œå¯èƒ½å¹¶ä¸ç¨³å®šï¼Œè‹¥æœ‰bugå¯å‘é€issueæˆ–è€…åŠ ç¾¤åé¦ˆã€‚ï¼ˆæ™ºæ…§èŒæ•™ä»…æ”¯æŒWindowsç³»ç»Ÿï¼‰

jobs:
  build:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            arch: amd64
            goos: linux
          - os: ubuntu-22.04
            arch: arm64
            goos: linux
          - os: windows-latest
            arch: amd64
            goos: windows
          - os: macos-latest
            arch: amd64
            goos: darwin
          - os: macos-latest
            arch: arm64
            goos: darwin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Release Directory
        run: mkdir -p ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{matrix.goos}}-${{matrix.arch}}-release

        # ============================================================
      # Linux æž„å»ºæµç¨‹ï¼ˆçœŸæ­£ç¨³å®šç‰ˆæœ¬ï¼‰
      # ============================================================
      - name: Install Go on Host
        if: runner.os == 'Linux'
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build Linux inside CentOS7 (glibc 2.17)
        if: runner.os == 'Linux'
        run: |
          docker run --rm \
            -v $PWD:/app \
            -v $(go env GOROOT):/goroot \
            -w /app \
            centos:7 \
          bash -c "
            echo '--- Fixing CentOS7 yum repo ---'
            sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-*.repo
            sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*.repo

            yum clean all
            yum makecache
            yum install -y gcc gcc-c++ make

            # use Go from setup-go
            export GOROOT=/goroot
            export PATH=\$GOROOT/bin:\$PATH
            go version

            echo '--- Building Linux Binary ---'
            CGO_ENABLED=1 GOOS=linux GOARCH=${{ matrix.arch }} go build \
              -o ${RELEASE_DIR}/yatori-go-console.${VERSION}-linux-${{matrix.arch}}-release/${PROJECT_NAME}
          "


      # ============================================================
      # Windows æž„å»º
      # ============================================================
      - name: Set up Go (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build Windows
        if: runner.os == 'Windows'
        run: |
          set CGO_ENABLED=1
          set GOOS=windows
          set GOARCH=${{ matrix.arch }}
          go build -o ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release\${{ env.PROJECT_NAME }}.exe

      # ============================================================
      # macOS æž„å»º
      # ============================================================
      - name: Set up Go (macOS)
        if: runner.os == 'macOS'
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build macOS
        if: matrix.goos == 'darwin'
        run: |
          CGO_ENABLED=1 GOOS=darwin GOARCH=${{ matrix.arch }} go build \
            -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      # ============================================================
      # Packaging
      # ============================================================

      - name: Copy config files
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release || true
          cp command/start.bat ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release 2>/dev/null || true

      - name: Create release archive
        run: |
          cd ${{ env.RELEASE_DIR }}
          if [ "${{ runner.os }}" = "Windows" ]; then
            Compress-Archive -Path "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release" -DestinationPath "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release.zip"
            Remove-Item -Recurse -Force "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release"
          else
            tar -czvf yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release.tar.gz yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release
            rm -rf yatori-go-console.${{env.VERSION}}-${{ matrix.goos }}-${{ matrix.arch }}-release
          fi

      # ============================================================
      # Release Upload
      # ============================================================

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          draft: false
          prerelease: false
