name: Go Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v2.6.1-Beta.3'

permissions:
  contents: write

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BUILD_DATE: ${{ github.run_id }}
  VERSION: ${{ github.ref_name }}
  RELEASE_DIR: release
  RELEASE_NOTICES: |
    - [ğŸ”§] ä¿®å¤é’ä¹¦å­¦å ‚æ— æ³•æ­£å¸¸å†™ä½œä¸šé—®é¢˜
    - [ğŸ”§] ä¿®å¤Linuxä¸‹éƒ¨åˆ†æ¥å£å‡ºç°è¯ä¹¦æ ¡éªŒé”™è¯¯é—®é¢˜
    - [â€ğŸ”§] ä¿®å¤å­¦ä¹ é€šéƒ¨åˆ†è¯¾ç¨‹æ— æ³•æ­£å¸¸è¿‡äººè„¸é—®é¢˜
    
    
    å­¦ä¹ é€šç”¨æˆ·æ³¨æ„ï¼š
        å¦‚æœå­¦ä¹ é€šè¯¾ç¨‹ä¸­æœ‰å‰ç½®ä»»åŠ¡ç‚¹å®Œæˆæ‰èƒ½è§£é”åç»­ä»»åŠ¡çš„ä¸èƒ½ä½¿ç”¨å¤šä»»åŠ¡ç‚¹æ¨¡å¼ï¼ï¼ï¼ï¼ˆå¤šä»»åŠ¡ç‚¹æ¨¡å¼ä¼šå¤±æ•ˆï¼‰
        æ¯å¤©å­¦ä¹ ç´¯è®¡å­¦æ—¶ä¸è¦å¤ªä¹…ï¼Œè¶…è¿‡1200åˆ†é’Ÿå¯èƒ½ä¼šæ‰“å›å­¦ä¹ è¿›åº¦ï¼ˆå°¤å…¶æ˜¯å¤šè¯¾ç¨‹æˆ–å¤šä»»åŠ¡ç‚¹æ¨¡å¼ï¼‰ï¼Œè¯·è‡ªè¡ŒæŠŠæ§å¥½ã€‚å› ä¸ºå¤ªç¦»è°±äº†ã€‚
    
    æ³¨ï¼šæ™ºæ…§èŒæ•™åˆšä¸Šçº¿ï¼Œå¯èƒ½å¹¶ä¸ç¨³å®šï¼Œè‹¥æœ‰bugå¯å‘é€issueæˆ–è€…åŠ ç¾¤åé¦ˆã€‚ï¼ˆæ™ºæ…§èŒæ•™ä»…æ”¯æŒWindowsç³»ç»Ÿï¼‰

jobs:
  build:
    name: Build (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            goos: linux
          - os: ubuntu-latest
            arch: arm64
            goos: linux
          - os: windows-latest
            arch: amd64
            goos: windows
          - os: macos-latest
            arch: amd64
            goos: darwin
          - os: macos-latest
            arch: arm64
            goos: darwin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------
      # ğŸ”¥ å®‰è£… OpenCVï¼ˆGoCV å¿…é¡»ï¼‰
      # -----------------------------------------------------
      - name: Install OpenCV for GoCV (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopencv-dev \
            build-essential \
            pkg-config \
            libjpeg-dev libpng-dev libtiff-dev \
            libavformat-dev libavcodec-dev libavutil-dev \
            libswscale-dev libavresample-dev libgtk2.0-dev \
            libgtk-3-dev libtbb-dev libeigen3-dev

          # é¿å… ARM äº¤å‰ç¼–è¯‘å¤±è´¥
          sudo apt-get install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf

          # è¾“å‡º OpenCV ä¿¡æ¯ç¡®è®¤å¯ç”¨
          pkg-config --modversion opencv4 || true
          ls /usr/lib/pkgconfig | grep opencv || true
          echo "OpenCV å·²å®‰è£…å®Œæˆ"

      # -----------------------------------------------------
      # ğŸŸ¦ Go ç¯å¢ƒ
      # -----------------------------------------------------
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Get dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          export GOPROXY=direct
          rm -rf go.sum
          go clean -modcache
          go env -w GOSUMDB=off
          go mod tidy

      - name: Get dependencies (MacOS)
        if: runner.os == 'macOS'
        run: |
          export GOPROXY=direct
          rm -rf go.sum
          go clean -modcache
          go env -w GOSUMDB=off
          go mod tidy

      - name: Get dependencies (Windows)
        if: runner.os=='Windows'
        run: |
          set GOPROXY=direct
          go clean -modcache
          del go.sum
          go mod tidy

      - name: Prepare Release Directory
        run: mkdir -p ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-${{matrix.goos}}-${{matrix.arch}}-release


      # -----------------------------------------------------
      # ğŸŸ© å„å¹³å°ç¼–è¯‘
      # -----------------------------------------------------

      - name: Build Linux (amd64)
        if: runner.os=='Linux' && matrix.arch=='amd64'
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build \
          -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-linux-amd64-release/${{ env.PROJECT_NAME }}

      - name: Build Linux (arm64)
        if: runner.os=='Linux' && matrix.arch=='arm64'
        run: |
          CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build \
          -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-linux-arm64-release/${{ env.PROJECT_NAME }}

      - name: Build Windows
        if: runner.os == 'Windows'
        run: |
          set CGO_ENABLED=1
          set GOOS=windows
          set GOARCH=${{matrix.arch}}
          go build -o ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release\${{ env.PROJECT_NAME }}.exe

      - name: Build macOS
        if: matrix.goos == 'darwin'
        run: |
          CGO_ENABLED=1 GOOS=darwin GOARCH=${{ matrix.arch }} go build \
          -o ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release/${{ env.PROJECT_NAME }}

      # -----------------------------------------------------
      # ğŸ“¦ æ‰“åŒ… Linux
      # -----------------------------------------------------
      - name: Create release tar (Linux)
        if: runner.os=='Linux'
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          cd ${{ env.RELEASE_DIR }}
          tar -czvf yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release.tar.gz yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          rm -rf yatori-go-console.${{env.VERSION}}-linux-${{matrix.arch}}-release
          cd ..

      # -----------------------------------------------------
      # ğŸ“¦ æ‰“åŒ… Windows
      # -----------------------------------------------------
      - name: Create Release zip (Windows)
        if: runner.os=='Windows'
        run: |
          copy command\config.yaml ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release
          copy command\start.bat ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release
          copy command\åŒå‡»start.batå¯åŠ¨ç¨‹åº ${{ env.RELEASE_DIR }}\yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release
          cd ${{ env.RELEASE_DIR }}
          Compress-Archive -Path "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release" -DestinationPath "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release.zip"
          Remove-Item -Recurse -Force "yatori-go-console.${{env.VERSION}}-windows-${{matrix.arch}}-release"
          cd ..

      # -----------------------------------------------------
      # ğŸ“¦ æ‰“åŒ… macOS
      # -----------------------------------------------------
      - name: Create macOS Release tar
        if: matrix.goos == 'darwin'
        run: |
          cp command/config.yaml ${{ env.RELEASE_DIR }}/yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release
          cd ${{ env.RELEASE_DIR }}
          tar -czvf yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release.tar.gz yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release
          rm -rf yatori-go-console.${{env.VERSION}}-darwin-${{ matrix.arch }}-release
          cd ..

      # -----------------------------------------------------
      # ğŸš€ å‘å¸ƒ Release
      # -----------------------------------------------------
      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.RELEASE_DIR }}/*
          tag_name: ${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTICES }}
          draft: false
          prerelease: false
